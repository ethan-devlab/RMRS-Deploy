{% extends 'merchantsideapp/base_sidebar.html' %}
{% load static %}
{% block page_title %}商家設定{% endblock %}
{% block content %}
<!-- Header -->
<div class="welcome-box">
    <h1 class="text-2xl font-bold text-slate-800">商家設定中心</h1>
    <p class="text-slate-600 mt-1">調整帳戶與餐廳資訊，保持營運資料最新，方便消費者找到你。</p>
</div>

{% if restaurant_name_form %}
<!-- Restaurant Name Quick Edit -->
<div class="card mt-6">
    <h3 class="text-lg font-bold text-slate-800 mb-4">餐廳名稱</h3>
    <form method="post" class="space-y-4">
        {% csrf_token %}
        <input type="hidden" name="form_type" value="restaurant_name">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div class="form-group">
                <label class="form-label" for="merchant-restaurant-name">餐廳名稱</label>
                {{ restaurant_name_form.name }}
                {% if restaurant_name_form.name.errors %}<p class="form-error">{{ restaurant_name_form.name.errors.0 }}
                </p>{% endif %}
                <p class="text-xs text-slate-400 mt-1">此名稱會顯示於使用者端搜尋與推薦之中。</p>
            </div>
        </div>
        <button class="btn-primary" type="submit">更新餐廳名稱</button>
    </form>
</div>
{% endif %}

<!-- Account Info -->
<div class="card mt-6">
    <h3 class="text-lg font-bold text-slate-800 mb-4">帳戶資訊</h3>
    <form method="post" class="space-y-4">
        {% csrf_token %}
        <input type="hidden" name="form_type" value="account">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div class="form-group">
                <label class="form-label" for="merchant-name-display">商家名稱</label>
                <input id="merchant-name-display" type="text" value="{{ merchant.merchant_name }}"
                    class="w-full px-4 py-2 border border-slate-200 rounded-lg bg-slate-100 text-slate-500 cursor-not-allowed"
                    readonly>
                <small class="text-xs text-slate-400 mt-1 block">此名稱用於登入與識別，如需調整請聯絡客服協助。</small>
            </div>
            <div class="form-group">
                <label class="form-label" for="id_email">商家 Email</label>
                {{ account_form.email }}
                {% if account_form.email.errors %}<p class="form-error">{{ account_form.email.errors.0 }}</p>{% endif %}
            </div>
            <div class="form-group">
                <label class="form-label" for="id_phone">聯絡電話</label>
                {{ account_form.phone }}
                {% if account_form.phone.errors %}<p class="form-error">{{ account_form.phone.errors.0 }}</p>{% endif %}
            </div>
        </div>
        <button class="btn-primary" type="submit">更新帳戶</button>
    </form>
</div>

<!-- Password Change -->
<div class="card mt-6">
    <h3 class="text-lg font-bold text-slate-800 mb-4">變更密碼</h3>
    <form method="post" class="space-y-4">
        {% csrf_token %}
        <input type="hidden" name="form_type" value="password">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div class="form-group">
                <label class="form-label" for="id_current_password">目前密碼</label>
                {{ password_form.current_password }}
                {% if password_form.current_password.errors %}<p class="form-error">{{
                    password_form.current_password.errors.0 }}</p>{% endif %}
            </div>
            <div class="form-group">
                <label class="form-label" for="id_new_password1">新密碼</label>
                {{ password_form.new_password1 }}
                {% if password_form.new_password1.errors %}<p class="form-error">{{ password_form.new_password1.errors.0
                    }}</p>{% endif %}
            </div>
            <div class="form-group">
                <label class="form-label" for="id_new_password2">再次輸入新密碼</label>
                {{ password_form.new_password2 }}
                {% if password_form.new_password2.errors %}<p class="form-error">{{ password_form.new_password2.errors.0
                    }}</p>{% endif %}
            </div>
        </div>
        {% if password_form.non_field_errors %}
        <div class="alert-error">{{ password_form.non_field_errors }}</div>
        {% endif %}
        <p class="text-sm text-slate-500">建議使用 8 碼以上並混合大小寫及符號。</p>
        <button class="btn-primary" type="submit">更新密碼</button>
    </form>
</div>

<!-- Restaurant Info -->
<div class="card mt-6">
    <h3 class="text-lg font-bold text-slate-800 mb-4">餐廳資訊</h3>
    <form method="post" class="space-y-4">
        {% csrf_token %}
        <input type="hidden" name="form_type" value="restaurant">
        {{ restaurant_form.name.as_hidden }}
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div class="form-group">
                <label class="form-label" for="id_address">地址</label>
                {{ restaurant_form.address }}
                {% if restaurant_form.address.errors %}<p class="form-error">{{ restaurant_form.address.errors.0 }}</p>
                {% endif %}
            </div>
            <div class="form-group">
                <label class="form-label" for="id_city">城市</label>
                {{ restaurant_form.city }}
                {% if restaurant_form.city.errors %}<p class="form-error">{{ restaurant_form.city.errors.0 }}</p>
                {% endif %}
            </div>
            <div class="form-group">
                <label class="form-label" for="id_district">行政區</label>
                {{ restaurant_form.district }}
                {% if restaurant_form.district.errors %}<p class="form-error">{{ restaurant_form.district.errors.0 }}
                </p>{% endif %}
            </div>
            <div class="form-group">
                <label class="form-label" for="id_phone">聯絡電話</label>
                {{ restaurant_form.phone }}
                {% if restaurant_form.phone.errors %}<p class="form-error">{{ restaurant_form.phone.errors.0 }}</p>
                {% endif %}
            </div>
            <div class="form-group">
                <label class="form-label" for="id_cuisine_type">料理風格</label>
                {{ restaurant_form.cuisine_type }}
                {% if restaurant_form.cuisine_type.errors %}<p class="form-error">
                    {{ restaurant_form.cuisine_type.errors.0 }}</p>{% endif %}
            </div>
            <div class="form-group">
                <label class="form-label" for="id_price_range">價位區間</label>
                {{ restaurant_form.price_range }}
                {% if restaurant_form.price_range.errors %}<p class="form-error">
                    {{ restaurant_form.price_range.errors.0 }}</p>{% endif %}
            </div>
            <div class="form-group">
                <label class="form-label" for="id_latitude">緯度</label>
                {{ restaurant_form.latitude }}
                {% if restaurant_form.latitude.errors %}<p class="form-error">
                    {{ restaurant_form.latitude.errors.0 }}
                </p>{% endif %}
            </div>
            <div class="form-group">
                <label class="form-label" for="id_longitude">經度</label>
                {{ restaurant_form.longitude }}
                {% if restaurant_form.longitude.errors %}<p class="form-error">
                    {{ restaurant_form.longitude.errors.0 }}
                </p>
                {% endif %}
            </div>
        </div>
        <button class="btn-primary" type="submit">更新餐廳資訊</button>
    </form>
</div>

{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('change', function() {
        var latitudeInput = document.getElementById('id_latitude');
        var longitudeInput = document.getElementById('id_longitude');
        if (latitudeInput.value) {
            var lat = latitudeInput.value.trim();
            lat = parseFloat(lat).toFixed(7);
            latitudeInput.value = lat;
        }
        if (longitudeInput.value) {
            var lon = longitudeInput.value.trim();
            lon = parseFloat(lon).toFixed(7);
            longitudeInput.value = lon;
        }
    })
</script>
{% endblock %}