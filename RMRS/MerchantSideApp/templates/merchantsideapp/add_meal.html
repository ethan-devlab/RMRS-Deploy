{% extends 'merchantsideapp/base_sidebar.html' %}
{% load static %}
{% block page_title %}Foodie · {{ page_title|default:"新增餐點" }}{% endblock %}

{% block content %}
<div class="card">
    <!-- Header -->
    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 mb-6 pb-4 border-b">
        <div>
            <p class="text-sm text-gray-500 mb-1">{{ page_title|default:"新增餐點" }}</p>
            {% if is_edit and meal %}
            <h1 class="text-xl font-bold text-gray-900">正在編輯：{{ meal.name }}</h1>
            {% else %}
            <h1 class="text-xl font-bold text-gray-900">餐點基本資料</h1>
            {% endif %}
        </div>
        {% if is_edit %}
        <a class="btn-secondary text-sm px-4 py-2" href="{% url 'merchantsideapp:add_meal' %}">＋ 改為新增</a>
        {% endif %}
    </div>

    <!-- Form -->
    <form method="post" enctype="multipart/form-data" class="space-y-6" novalidate>
        {% csrf_token %}
        {% include 'shared/components/form_errors.html' with form=form %}

        <!-- Name & Category -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div class="form-group">
                <label class="form-label" for="{{ form.name.id_for_label }}">品項名稱 <span
                        class="text-red-500">*</span></label>
                {{ form.name }}
                {% for error in form.name.errors %}<p class="form-error">{{ error }}</p>{% endfor %}
            </div>
            <div class="form-group">
                <label class="form-label" for="{{ form.category.id_for_label }}">品項類別 <span
                        class="text-red-500">*</span></label>
                {{ form.category }}
                {% for error in form.category.errors %}<p class="form-error">{{ error }}</p>{% endfor %}
            </div>
        </div>

        <!-- Description -->
        <div class="form-group">
            <label class="form-label" for="{{ form.description.id_for_label }}">品項敘述</label>
            {{ form.description }}
            {% for error in form.description.errors %}<p class="form-error">{{ error }}</p>{% endfor %}
        </div>

        <!-- Price & Image URL -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div class="form-group">
                <label class="form-label" for="{{ form.price.id_for_label }}">價格（元） <span
                        class="text-red-500">*</span></label>
                {{ form.price }}
                {% for error in form.price.errors %}<p class="form-error">{{ error }}</p>{% endfor %}
            </div>
            <div class="form-group">
                <label class="form-label" for="{{ form.image_url.id_for_label }}">餐點照片（URL）</label>
                {{ form.image_url }}
                {% for error in form.image_url.errors %}<p class="form-error">{{ error }}</p>{% endfor %}
            </div>
        </div>

        <!-- Image Upload -->
        <div class="form-group">
            <label class="form-label" for="{{ form.image_file.id_for_label }}">或上傳餐點照片</label>
            {{ form.image_file }}
            <p class="text-xs text-gray-400 mt-1">支援 jpg / png，建議 5MB 以內</p>
            {% for error in form.image_file.errors %}<p class="form-error">{{ error }}</p>{% endfor %}
            {% if is_edit and meal %}
            <div class="mt-3">
                <p class="text-sm text-gray-500 mb-2">目前餐點照片</p>
                {% with current_image=meal.get_image_source %}
                {% if current_image %}
                <img src="{{ current_image }}" alt="{{ meal.name }} 目前圖片"
                    class="w-32 h-32 object-cover rounded-lg border">
                {% else %}
                <div
                    class="w-32 h-32 bg-gray-100 rounded-lg border flex items-center justify-center text-gray-400 text-sm">
                    尚未上傳</div>
                {% endif %}
                {% endwith %}
            </div>
            {% endif %}
        </div>

        <!-- Toggles -->
        <div class="flex flex-wrap gap-6">
            <label class="flex items-center gap-2 cursor-pointer">
                {{ form.is_vegetarian }}
                <span class="text-gray-700">提供素食選項</span>
            </label>
            <label class="flex items-center gap-2 cursor-pointer">
                {{ form.is_spicy }}
                <span class="text-gray-700">含辛香/辣味</span>
            </label>
        </div>

        <!-- Nutrition Section -->
        <div class="border-t pt-6 mt-6">
            <div class="mb-4">
                <h3 class="text-lg font-semibold text-gray-900 mb-1">餐點營養成分</h3>
                <p class="text-sm text-gray-500">新增每份營養數值，將會儲存在 nutrition_info 資料表中。</p>
                <div class="flex gap-2 mt-2">
                    <span class="pill-primary text-xs">每 1 份</span>
                    <span class="pill-gray text-xs">以標準 100g/100ml 計</span>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
                <!-- Nutrition Form -->
                <div class="card bg-gray-50">
                    <div class="grid grid-cols-2 gap-3">
                        <div class="form-group">
                            <label class="form-label text-xs" for="nutrition-name">成分名稱</label>
                            <input type="text" id="nutrition-name" placeholder="如：蛋白質" class="form-input">
                        </div>
                        <div class="form-group">
                            <label class="form-label text-xs" for="nutrition-quantity">份量 / 單位</label>
                            <input type="text" id="nutrition-quantity" placeholder="1 份 / 250 ml" class="form-input">
                        </div>
                        <div class="form-group">
                            <label class="form-label text-xs" for="nutrition-calories">熱量 (kcal)</label>
                            <input type="number" step="0.1" min="0" id="nutrition-calories" placeholder="0"
                                class="form-input">
                        </div>
                        <div class="form-group">
                            <label class="form-label text-xs" for="nutrition-protein">蛋白質 (g)</label>
                            <input type="number" step="0.1" min="0" id="nutrition-protein" placeholder="0"
                                class="form-input">
                        </div>
                        <div class="form-group">
                            <label class="form-label text-xs" for="nutrition-carb">碳水 (g)</label>
                            <input type="number" step="0.1" min="0" id="nutrition-carb" placeholder="0"
                                class="form-input">
                        </div>
                        <div class="form-group">
                            <label class="form-label text-xs" for="nutrition-fat">脂肪 (g)</label>
                            <input type="number" step="0.1" min="0" id="nutrition-fat" placeholder="0"
                                class="form-input">
                        </div>
                        <div class="form-group col-span-2">
                            <label class="form-label text-xs" for="nutrition-notes">備註 (選填)</label>
                            <input type="text" id="nutrition-notes" placeholder="例如：含堅果、孕婦慎用等貼心提醒" class="form-input">
                        </div>
                    </div>
                    <div class="mt-4 flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
                        <p class="text-xs text-gray-500">輸入完成後點選按鈕，將成分加入本次餐點。</p>
                        <div class="flex gap-2">
                            <button type="button" class="btn-secondary text-sm px-4 py-2"
                                id="nutrition-add-btn">加入營養成分</button>
                            <button type="button" class="btn-secondary text-sm px-4 py-2 border-gray-300 text-gray-600"
                                id="nutrition-cancel-btn" hidden>取消編輯</button>
                        </div>
                    </div>
                </div>

                <!-- Nutrition Preview -->
                <div class="card border-2 border-dashed border-gray-200">
                    <div class="flex items-center justify-between mb-3">
                        <div>
                            <p class="font-medium text-gray-900">本次新增成分</p>
                            <p class="text-xs text-gray-500">已加入 <span id="nutrition-count">0</span> 項</p>
                        </div>
                        <span class="pill-info text-xs">營養資訊預覽</span>
                    </div>
                    <div class="text-red-500 text-sm" id="nutrition-error"></div>
                    <div class="space-y-2" id="nutrition-list"></div>
                </div>
            </div>
            {{ form.nutrition_payload }}
            {% for error in form.nutrition_payload.errors %}<p class="form-error">{{ error }}</p>{% endfor %}
        </div>

        <!-- Actions -->
        <div class="flex gap-3 pt-4 border-t">
            <button type="submit" class="btn-primary px-6">{% if is_edit %}儲存變更{% else %}儲存餐點{% endif %}</button>
            <button type="reset" class="btn-secondary px-6">清除內容</button>
        </div>
    </form>
</div>
{% endblock %}

{% block extra_js %}
<script src="{% static 'merchantsideapp/js/merchant_add_meal.js' %}"></script>
{% endblock %}