{% extends 'usersideapp/base_sidebar.html' %}
{% load static %}
{% block page_title %}搜尋餐廳{% endblock %}
{% block extra_css %}
<link rel="stylesheet" href="{% static 'usersideapp/css/Search_rest.css' %}">
{% endblock %}
{% block content %}
<div class="search-page">
    <div class="map-shell">
        <div class="map-controls">
            <div class="search-panel search-panel--docked">
                <div class="search-header">
                    <div>
                        <h1>探索附近餐廳</h1>
                        <p>使用條件篩選快速找到餐廳，並在地圖上查看實際位置。</p>
                    </div>
                    <div class="result-count">
                        <span>{{ result_count }} 家餐廳</span>
                        {% if limit_reached %}
                        <small>僅顯示前 {{ restaurants|length }} 筆，請縮小條件以顯示更多</small>
                        {% endif %}
                    </div>
                </div>
                <form method="get" class="search-form" autocomplete="off">
                    <div class="search-field search-field--primary">
                        <span class="search-icon">🔍</span>
                        {{ form.keyword }}
                        <button type="submit" class="search-submit">搜尋</button>
                    </div>
                    <div class="search-filters">
                        <label class="filter-field">
                            <span>{{ form.city.label }}</span>
                            {{ form.city }}
                        </label>
                        <label class="filter-field">
                            <span>{{ form.district.label }}</span>
                            {{ form.district }}
                        </label>
                        <label class="filter-field">
                            <span>{{ form.cuisine_type.label }}</span>
                            {{ form.cuisine_type }}
                        </label>
                        <label class="filter-field">
                            <span>{{ form.price_range.label }}</span>
                            {{ form.price_range }}
                        </label>
                    </div>
                    <div class="search-actions">
                        <button type="button" class="locate-button" data-locate-btn>使用目前位置</button>
                        <span class="locate-status" data-location-status>
                            {% if has_user_location %}已套用目前位置{% else %}自動偵測附近位置中...{% endif %}
                        </span>
                    </div>
                    {% if selected_location_display or nearest_distance_label %}
                    <div class="location-summary">
                        {% if selected_location_display %}
                        <div class="location-summary__item">
                            <span class="location-summary__label">目前搜尋位置</span>
                            <span class="location-summary__value">{{ selected_location_display }}</span>
                        </div>
                        {% endif %}
                        {% if nearest_distance_label %}
                        <div class="location-summary__item">
                            <span class="location-summary__label">最近餐廳距離</span>
                            <span class="location-summary__value">{{ nearest_distance_label }}</span>
                        </div>
                        {% endif %}
                    </div>
                    {% endif %}
                    {{ form.latitude }}
                    {{ form.longitude }}
                </form>
                {% if form.errors %}
                <div class="form-errors">
                    {% for field in form %}
                    {% for error in field.errors %}
                    <p>{{ field.label }}：{{ error }}</p>
                    {% endfor %}
                    {% endfor %}
                    {% for error in form.non_field_errors %}
                    <p>{{ error }}</p>
                    {% endfor %}
                </div>
                {% endif %}
            </div>
            {% if map_hint %}
            <p class="map-hint map-hint--inline">{{ map_hint }}</p>
            {% endif %}
        </div>
        <div class="map-stage">
            <div class="map-frame">
                {% if folium_map %}
                <div class="map-toolbar">
                    <p>可拖曳、使用當前位置或直接點擊地圖來設定搜尋座標。</p>
                </div>
                <div class="folium-map" data-map-id="{{ folium_map_id }}">
                    {{ folium_map|safe }}
                </div>
                {% else %}
                <div class="map-placeholder">
                    <p>地圖載入失敗，請重新整理頁面。</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <section class="search-results">
        <div class="results-header">
            <h2>搜尋結果</h2>
        </div>
        <div class="result-list">
            {% for restaurant in restaurants %}
            <article class="result-card">
                <div class="result-card-header">
                    <h3>{{ restaurant.name }}</h3>
                    {% if restaurant.rating %}
                    <span class="rating-badge">★ {{ restaurant.rating }}</span>
                    {% endif %}
                </div>
                <p class="result-meta">
                    {{ restaurant.city|default:"" }}{{ restaurant.district|default:"" }}
                    {% if restaurant.cuisine_type %}
                    · {{ restaurant.cuisine_type }}
                    {% endif %}
                </p>
                {% if restaurant.address %}
                <p class="result-address">{{ restaurant.address }}</p>
                {% endif %}
                {% if restaurant.user_distance_km %}
                <p class="result-distance">距離目前位置約 {{ restaurant.user_distance_km|floatformat:1 }} 公里</p>
                {% endif %}
                <div class="result-tags">
                    <span class="tag">{{ restaurant.get_price_range_display }}</span>
                    {% if restaurant.latitude and restaurant.longitude %}
                    <span class="tag tag--success">已提供座標</span>
                    {% else %}
                    <span class="tag tag--muted">未提供座標</span>
                    {% endif %}
                {% if restaurant.latitude and restaurant.longitude %}
                <div class="result-actions">
                    <button type="button"
                            class="result-action-btn"
                            data-nav-btn
                            data-dest-lat="{{ restaurant.latitude }}"
                            data-dest-lon="{{ restaurant.longitude }}">
                        開始導航
                    </button>
                </div>
                {% endif %}
                </div>
            </article>
            {% empty %}
            <div class="result-empty">
                <p>目前沒有符合條件的餐廳，請調整篩選條件後再試一次。</p>
            </div>
            {% endfor %}
        </div>
    </section>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener("DOMContentLoaded", function () {
        const form = document.querySelector(".search-form");
        const latInput = document.getElementById("{{ form.latitude.auto_id }}");
        const lonInput = document.getElementById("{{ form.longitude.auto_id }}");
        const statusEl = document.querySelector("[data-location-status]");
        const locateBtn = document.querySelector("[data-locate-btn]");
        const mapWrapper = document.querySelector(".folium-map");
        const mapId = mapWrapper ? mapWrapper.dataset.mapId : null;
        const navButtons = Array.from(document.querySelectorAll("[data-nav-btn]"));

        if (!form || !latInput || !lonInput) {
            return;
        }

        const hasCoords = Boolean(latInput.value && lonInput.value);

        function setStatus(message, state) {
            if (!statusEl) {
                return;
            }
            statusEl.textContent = message;
            statusEl.dataset.state = state || "";
        }

        function applyCoordinates(lat, lon, autoSubmit, statusMessage) {
            const latNum = parseFloat(lat);
            const lonNum = parseFloat(lon);
            if (Number.isNaN(latNum) || Number.isNaN(lonNum)) {
                return false;
            }
            latInput.value = latNum.toFixed(6);
            lonInput.value = lonNum.toFixed(6);
            if (statusMessage) {
                setStatus(statusMessage, "success");
            }
            if (navButtons.length) {
                updateNavigationButtons();
            }
            if (autoSubmit) {
                form.submit();
            }
            return true;
        }

        function requestLocation(autoSubmit) {
            if (!navigator.geolocation) {
                setStatus("瀏覽器不支援定位功能", "error");
                return;
            }
            setStatus("正在取得位置...", "pending");
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    applyCoordinates(
                        position.coords.latitude,
                        position.coords.longitude,
                        autoSubmit,
                        "已使用目前位置"
                    );
                },
                () => {
                    setStatus("無法取得位置，請允許存取或稍後再試。", "error");
                },
                { enableHighAccuracy: true, timeout: 10000 }
            );
        }

        window.addEventListener("message", function (event) {
            const data = event.data || {};
            if (data.type !== "rmrs-map-click") {
                return;
            }
            if (mapId && data.mapId && data.mapId !== mapId) {
                return;
            }
            applyCoordinates(data.lat, data.lng, true, "已套用地圖座標");
        });

        if (locateBtn) {
            locateBtn.addEventListener("click", function () {
                requestLocation(true);
            });
        }

        function getOriginCoords() {
            const originLat = parseFloat(latInput.value);
            const originLon = parseFloat(lonInput.value);
            if (Number.isNaN(originLat) || Number.isNaN(originLon)) {
                return null;
            }
            return { lat: originLat, lon: originLon };
        }

        function updateNavigationButtons() {
            if (!navButtons.length) {
                return;
            }
            const origin = getOriginCoords();
            navButtons.forEach((btn) => {
                const destLat = parseFloat(btn.dataset.destLat);
                const destLon = parseFloat(btn.dataset.destLon);
                const hasDestination = Number.isFinite(destLat) && Number.isFinite(destLon);
                if (!hasDestination) {
                    btn.disabled = true;
                    btn.title = "此餐廳缺少完整座標資訊";
                    return;
                }
                if (!origin) {
                    btn.disabled = true;
                    btn.title = "請先設定目前位置後再使用導航";
                    return;
                }
                btn.disabled = false;
                btn.removeAttribute("title");
            });
        }

        function openNavigation(btn) {
            const origin = getOriginCoords();
            const destLat = parseFloat(btn.dataset.destLat);
            const destLon = parseFloat(btn.dataset.destLon);
            if (!origin || !Number.isFinite(destLat) || !Number.isFinite(destLon)) {
                return;
            }
            const url = new URL("https://www.google.com/maps/dir/");
            url.searchParams.set("api", "1");
            url.searchParams.set("origin", origin.lat + "," + origin.lon);
            url.searchParams.set("destination", destLat + "," + destLon);
            window.open(url.toString(), "_blank", "noopener");
        }

        if (navButtons.length) {
            navButtons.forEach((btn) => {
                btn.addEventListener("click", function (event) {
                    event.preventDefault();
                    if (btn.disabled) {
                        return;
                    }
                    openNavigation(btn);
                });
            });
            updateNavigationButtons();
        }

        if (!hasCoords) {
            requestLocation(true);
        } else {
            setStatus("已使用目前位置", "success");
        }
    });
</script>
{% endblock %}

