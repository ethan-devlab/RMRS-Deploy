{% extends 'usersideapp/base_sidebar.html' %}
{% block page_title %}推播通知{% endblock %}
{% block content %}
<div class="welcome-box notify-header">
    <div class="notify-left">
        <h1>推播通知</h1>
        <p>設定提醒時間並檢視最近推播，確保不錯過任何餐次。</p>
    </div>
    <div class="notify-right">
        <form method="post">
            {% csrf_token %}
            <input type="hidden" name="action" value="send_preview">
            <button class="outline-btn" type="submit">＋ 建立測試提醒</button>
        </form>
    </div>
</div>

<div class="section-title">提醒設定</div>
<form method="post" class="card-long notify-settings">
    {% csrf_token %}
    <input type="hidden" name="action" value="update_settings">
    {{ formset.management_form }}
    {% for form in formset %}
    <div class="notify-row">
        <div class="notify-info">
            <div class="notify-title">{{ form.instance.get_reminder_type_display }}</div>
            <div class="notify-sub">頻道：{{ form.instance.get_channel_display }}</div>
        </div>
        <div class="notify-actions">
            {{ form.scheduled_time }}
            {{ form.channel }}
            <label class="switch small">
                {{ form.is_enabled }}
                <span class="slider"></span>
            </label>
        </div>
        {{ form.id }}
    </div>
    {% if form.errors %}
    <div class="form-errors">{{ form.errors }}</div>
    {% endif %}
    {% endfor %}
    <button class="primary-btn" type="submit">儲存提醒設定</button>
</form>

<div class="section-title">近期通知</div>
{% if notification_logs %}
<div class="record-list">
    {% for log in notification_logs %}
    <div class="card-long notify-item {% if log.status == 'read' %}is-read{% endif %}">
        <div class="notify-item-main">
            <div>
                <div class="notify-item-title">{{ log.title }}</div>
                <div class="notify-item-sub">{{ log.body }}</div>
            </div>
            <div class="notify-item-meta">
                <span class="notify-badge">{{ log.notification_type|default:"提醒" }}</span>
                <span class="notify-time-text">{{ log.sent_at|date:"m/d H:i" }}</span>
            </div>
        </div>
        {% if log.status != 'read' %}
        <form method="post" class="inline-form">
            {% csrf_token %}
            <input type="hidden" name="action" value="mark_read">
            <input type="hidden" name="log_id" value="{{ log.id }}">
            <button type="submit" class="text-btn">標記已讀</button>
        </form>
        {% else %}
        <span class="badge muted">已讀</span>
        {% endif %}
    </div>
    {% endfor %}
</div>
{% else %}
<div class="card-long empty-state">尚未收到推播通知。</div>
{% endif %}
{% endblock %}