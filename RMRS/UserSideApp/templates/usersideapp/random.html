{% extends 'usersideapp/base_sidebar.html' %}
{% load static %}
{% block page_title %}隨機推薦{% endblock %}
{% block content %}
<!-- Header -->
<div class="welcome-box flex flex-col sm:flex-row sm:items-start sm:justify-between gap-4">
    <div>
        <h1 class="text-2xl font-bold text-slate-800">隨機推薦</h1>
        <p class="text-slate-600 mt-1">參考你的偏好、熱門收藏與資料庫策略，挑選今日最適合的餐點。</p>
    </div>
    {% if preference_snapshot %}
    <div class="px-4 py-2 bg-white/80 rounded-xl border border-slate-200 shadow-sm">
        <span class="text-sm text-slate-500">目前偏好</span>
        <strong class="block text-slate-800">{{ preference_snapshot }}</strong>
    </div>
    {% endif %}
</div>

<!-- Filter Form -->
<div class="card mt-6">
    <div class="mb-4">
        <h3 class="text-lg font-bold text-slate-800">設定條件</h3>
        <p class="text-sm text-slate-500">可自訂條件或直接套用既有偏好</p>
    </div>
    <form method="post" class="space-y-6" data-endpoint="{% url 'usersideapp:random_data' %}">
        {% csrf_token %}
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 gap-4">
            <div class="form-group">
                <label class="form-label" for="id_cuisine_type">料理類型</label>
                {{ filter_form.cuisine_type }}
            </div>
            <div class="form-group">
                <label class="form-label" for="id_price_range">價格範圍</label>
                {{ filter_form.price_range }}
            </div>
            <div class="form-group">
                <label class="form-label" for="id_category">品項類別</label>
                {{ filter_form.category }}
            </div>
            <div class="form-group">
                <label class="form-label" for="id_city">城市</label>
                {{ filter_form.city }}
            </div>
            <div class="form-group">
                <label class="form-label" for="id_district">行政區</label>
                {{ filter_form.district }}
            </div>
        </div>
        <div class="flex flex-wrap items-end gap-6">
            <div>
                <span class="block text-sm font-medium text-slate-700 mb-2">飲食偏好</span>
                <div class="flex flex-wrap gap-3">
                    <label
                        class="inline-flex items-center gap-2 px-3 py-2 bg-slate-50 rounded-lg border border-slate-200 cursor-pointer hover:bg-slate-100 transition-colors">
                        {{ filter_form.is_vegetarian }}
                        <span class="text-sm text-slate-700">僅顯示素食</span>
                    </label>
                    <label
                        class="inline-flex items-center gap-2 px-3 py-2 bg-slate-50 rounded-lg border border-slate-200 cursor-pointer hover:bg-slate-100 transition-colors">
                        {{ filter_form.avoid_spicy }}
                        <span class="text-sm text-slate-700">避免辛辣</span>
                    </label>
                </div>
            </div>
            <div class="form-group">
                <label class="form-label" for="id_limit">推薦數量</label>
                <div class="flex items-center gap-2">
                    {{ filter_form.limit }}
                    <small class="text-xs text-slate-400">1–12 筆</small>
                </div>
            </div>
        </div>
        <div class="form-errors hidden" id="filter-errors" {% if not filter_form.errors %}hidden{% endif %}>
            {% for field in filter_form %}
            {% for error in field.errors %}
            <p class="text-sm text-red-600">{{ field.label }}：{{ error }}</p>
            {% endfor %}
            {% endfor %}
            {% for error in filter_form.non_field_errors %}
            <p class="text-sm text-red-600">{{ error }}</p>
            {% endfor %}
        </div>
        <div class="flex flex-wrap gap-3 pt-2">
            <button class="btn-primary" type="submit" name="action" value="filters">取得推薦</button>
            <button class="btn-secondary" type="submit" name="action" value="use_preferences">套用我的偏好</button>
            <button
                class="text-sm font-medium text-primary hover:text-primary-dark hover:underline px-4 py-2 border-primary-200 border rounded-full transition"
                type="submit" name="action" value="surprise">給我驚喜</button>
        </div>
    </form>
</div>

<!-- Primary Recommendations -->
<div class="card mt-6">
    <div class="mb-4">
        <h3 class="text-lg font-bold text-slate-800">智慧推薦</h3>
        <p class="text-sm text-slate-600" id="primary-reason">{{ primary_reason }}</p>
        <p class="text-xs text-slate-400 mt-1" id="recommendation-cooldown-hint"
            data-template="系統會避免推薦過去 {days} 天內你選過的餐點。">
            系統會避免推薦過去 {{ cooldown_days }} 天內你選過的餐點。
        </p>
    </div>
    <div class="alert-info mb-4" id="recommendation-alert" {% if not recommendation_alert %}hidden{% endif %}>
        {{ recommendation_alert|default_if_none:"" }}</div>
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4" id="primary-recommendation-grid"
        data-empty-text="暫時沒有符合條件的餐點，試著調整條件或點擊「給我驚喜」。">
        {% for card in primary_recommendations %}
        <div
            class="p-4 bg-slate-50 rounded-xl border border-slate-200 hover:border-primary/50 hover:shadow-md transition-all">
            <div class="flex items-start justify-between gap-2 mb-2">
                <div>
                    <h4 class="font-bold text-slate-800">
                        <a class="hover:text-primary hover:underline"
                            href="{% url 'merchantsideapp:meal_detail' card.meal.slug %}">{{ card.meal.name }}</a>
                    </h4>
                    <p class="text-sm text-slate-500">
                        <a class="hover:text-primary hover:underline"
                            href="{% url 'merchantsideapp:restaurant_detail' card.restaurant.slug %}">
                            {{ card.restaurant.name }}</a>
                    </p>
                </div>
                {% if card.favorite_count %}
                <span class="px-2 py-1 rounded-full bg-red-100 text-red-600 text-xs font-medium">❤️
                    {{ card.favorite_count }}</span>
                {% endif %}
            </div>
            <p class="text-xs text-slate-400 mb-2">
                {% if card.restaurant.cuisine_type %}<span>{{ card.restaurant.cuisine_type }}</span>{% endif %}
                {% if card.restaurant.price_range %}<span class="ml-2">價格 {{ card.restaurant.price_range }}</span>{% endif %}
                {% if card.restaurant.city %}<span class="ml-2">{{ card.restaurant.city }} {{ card.restaurant.district }}</span>{% endif %}
            </p>
            {% if card.meal.description %}
            <p class="text-sm text-slate-500 mb-3 line-clamp-2">{{ card.meal.description }}</p>
            {% endif %}
            <div class="flex flex-wrap gap-1">
                {% if card.meal.is_vegetarian %}
                <span class="pill-success">素</span>
                {% endif %}
                {% if not card.meal.is_spicy %}
                <span class="px-2 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-700">不辣</span>
                {% else %}
                <span class="pill-warning">微辣</span>
                {% endif %}
                {% if card.reason %}
                <span class="px-2 py-0.5 rounded-full text-xs font-medium bg-slate-100 text-slate-500">
                    {{ card.reason }}</span>
                {% endif %}
            </div>
        </div>
        {% endfor %}
        {% if not primary_recommendations %}
        <p class="text-slate-500 col-span-full text-center py-8">暫時沒有符合條件的餐點，試著調整條件或點擊「給我驚喜」。</p>
        {% endif %}
    </div>
</div>

<!-- Secondary Sections -->
<div id="secondary-sections" class="space-y-6 mt-6">
    {% for section in secondary_sections %}
    <div class="card">
        <div class="mb-4">
            <h3 class="text-lg font-bold text-slate-800">{{ section.title }}</h3>
            <p class="text-sm text-slate-500">{{ section.subtitle }}</p>
        </div>
        {% if section.cards %}
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-3">
            {% for card in section.cards %}
            <div class="p-3 bg-slate-50 rounded-lg border border-slate-200 hover:border-primary/50 transition-colors">
                <div class="flex items-start justify-between gap-2 mb-1">
                    <div>
                        <h4 class="font-semibold text-sm text-slate-800">
                            <a class="hover:text-primary hover:underline"
                                href="{% url 'merchantsideapp:meal_detail' card.meal.slug %}">{{ card.meal.name }}</a>
                        </h4>
                        <p class="text-xs text-slate-500">
                            <a class="hover:text-primary hover:underline"
                                href="{% url 'merchantsideapp:restaurant_detail' card.restaurant.slug %}">
                                {{ card.restaurant.name }}</a>
                        </p>
                    </div>
                    {% if card.favorite_count %}
                    <span class="px-1.5 py-0.5 rounded-full bg-red-100 text-red-600 text-xs">❤️
                        {{ card.favorite_count }}</span>
                    {% endif %}
                </div>
                <p class="text-xs text-slate-400 mb-2">
                    {% if card.restaurant.cuisine_type %}{{ card.restaurant.cuisine_type }}{% endif %}
                    {% if card.restaurant.price_range %} · 價格 {{ card.restaurant.price_range }}{% endif %}
                </p>
                <div class="flex flex-wrap gap-1">
                    {% if card.meal.is_vegetarian %}
                    <span class="pill-success text-[10px]">素</span>
                    {% endif %}
                    {% if not card.meal.is_spicy %}
                    <span class="px-1.5 py-0.5 rounded-full text-[10px] font-medium bg-blue-100 text-blue-700">不辣</span>
                    {% endif %}
                    {% if card.reason %}
                    <span class="px-1.5 py-0.5 rounded-full text-[10px] font-medium bg-slate-100 text-slate-500">
                        {{ card.reason }}</span>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <p class="text-slate-500">目前沒有資料可以顯示。</p>
        {% endif %}
    </div>
    {% endfor %}
</div>
{% endblock %}

{% block extra_js %}
<script src="{% static 'usersideapp/js/random_recommendations.js' %}"></script>
{% endblock %}