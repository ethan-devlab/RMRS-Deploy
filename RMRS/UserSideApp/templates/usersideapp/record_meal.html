{% extends 'usersideapp/base_sidebar.html' %}
{% load static %}
{% block page_title %}é£²é£Ÿç´€éŒ„{% endblock %}
{% block extra_js %}
<script src="{% static 'usersideapp/js/meal_record.js' %}" defer data-component-seed="{{ components_seed|escapejs }}"
    data-meal-api="{% url 'usersideapp:restaurant_meals_api' %}" data-initial-restaurant="{{ initial_restaurant_id }}"
    data-initial-meal="{{ initial_meal_id }}"></script>
{% endblock %}
{% block content %}
<!-- Header with filter bar -->
<div class="welcome-box flex flex-col lg:flex-row lg:items-start lg:justify-between gap-6">
    <div>
        <h1 class="text-2xl font-bold text-slate-800">é£²é£Ÿç´€éŒ„</h1>
        <p class="text-slate-600 mt-1">å»ºç«‹é£²é£Ÿæ—¥èªŒä¸¦è¿½è¹¤ç‡Ÿé¤Šæ”å–ï¼Œç³»çµ±æœƒè‡ªå‹•é¿å…åŒé¤é»æ–¼åŒä¸€é€±é‡è¤‡ã€‚</p>
    </div>
    <div class="flex flex-col items-end gap-3">
        <div class="flex flex-wrap gap-2">
            {% for value,label in range_filters %}
            <a class="px-3 py-1.5 rounded-full text-sm font-medium transition-colors {% if selected_range == value %}bg-primary text-white{% else %}bg-slate-100 text-slate-600 hover:bg-slate-200{% endif %}"
                href="?range={{ value }}">
                {{ label }}</a>
            {% endfor %}
        </div>
        <div class="text-right text-sm">
            <div class="font-semibold text-slate-800">{{ selected_range_meta.label }}</div>
            <div class="text-slate-500">{{ selected_range_meta.date_window }} Â· {{ selected_range_meta.days }} å¤©</div>
            <div class="text-slate-400 text-xs">{{ selected_range_meta.logic_hint }}</div>
        </div>
    </div>
</div>

<!-- Stats Card -->
<div class="card mt-6">
    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 mb-6">
        <div>
            <p class="text-xs uppercase tracking-wider text-slate-400 font-medium">æœŸé–“ç¸½è¦½</p>
            <h3 class="text-xl font-bold text-slate-800 mt-1">{{ selected_range_meta.label }}</h3>
            <p class="text-sm text-slate-500">{{ selected_range_meta.date_window }} Â· {{ selected_range_meta.days }} å¤©
            </p>
        </div>
        <div class="text-right">
            <span class="text-xs uppercase tracking-wider text-slate-400">ç´€éŒ„æ•¸é‡</span>
            <strong class="block text-3xl font-bold text-primary">{{ history_records|length }}</strong>
        </div>
    </div>
    <div class="grid grid-cols-2 lg:grid-cols-4 gap-4">
        <div
            class="flex items-center gap-3 p-4 rounded-xl bg-gradient-to-br from-orange-50 to-orange-100/50 border border-orange-200/50">
            <div class="text-2xl" aria-hidden="true">ğŸ”¥</div>
            <div>
                <span class="block text-xs text-orange-600 font-medium">å¡è·¯é‡Œ</span>
                <strong class="text-lg font-bold text-orange-700">{{ history_totals.total_calories|floatformat:0 }}
                    kcal</strong>
            </div>
        </div>
        <div
            class="flex items-center gap-3 p-4 rounded-xl bg-gradient-to-br from-amber-50 to-amber-100/50 border border-amber-200/50">
            <div class="text-2xl" aria-hidden="true">ğŸ¥š</div>
            <div>
                <span class="block text-xs text-amber-600 font-medium">è›‹ç™½è³ª</span>
                <strong class="text-lg font-bold text-amber-700">{{ history_totals.total_protein|floatformat:1 }}
                    g</strong>
            </div>
        </div>
        <div
            class="flex items-center gap-3 p-4 rounded-xl bg-gradient-to-br from-emerald-50 to-emerald-100/50 border border-emerald-200/50">
            <div class="text-2xl" aria-hidden="true">ğŸŒ¾</div>
            <div>
                <span class="block text-xs text-emerald-600 font-medium">ç¢³æ°´åŒ–åˆç‰©</span>
                <strong class="text-lg font-bold text-emerald-700">{{ history_totals.total_carbs|floatformat:1 }}
                    g</strong>
            </div>
        </div>
        <div
            class="flex items-center gap-3 p-4 rounded-xl bg-gradient-to-br from-violet-50 to-violet-100/50 border border-violet-200/50">
            <div class="text-2xl" aria-hidden="true">ğŸ¥‘</div>
            <div>
                <span class="block text-xs text-violet-600 font-medium">è„‚è‚ª</span>
                <strong class="text-lg font-bold text-violet-700">{{ history_totals.total_fat|floatformat:1 }}
                    g</strong>
            </div>
        </div>
    </div>
</div>

<!-- Form Section -->
<h2 class="text-lg font-bold text-slate-800 mt-8 mb-4" id="record-form-section">
    {% if editing_record %}ç·¨è¼¯é£²é£Ÿç´€éŒ„{% else %}æ–°å¢é£²é£Ÿç´€éŒ„{% endif %}
</h2>
<div class="card">
    <form method="post" id="meal-record-form" class="space-y-6">
        {% csrf_token %}
        <input type="hidden" name="intent" id="meal-form-intent"
            value="{% if editing_record %}update{% else %}create{% endif %}">
        <input type="hidden" name="record_id" id="meal-form-record-id" value="{{ editing_record.id|default:'' }}">
        {% if editing_record %}
        <div
            class="flex items-center justify-between p-3 bg-amber-50 border border-amber-200 rounded-lg text-amber-800">
            <span>æ­£åœ¨ç·¨è¼¯ï¼š{{ editing_record.date|date:"m/d" }} Â· {{ editing_record.get_meal_type_display }} Â·
                {{ editing_record.meal_name }}</span>
            <a class="text-sm font-medium text-amber-700 hover:text-amber-900 hover:underline"
                href="{% url 'usersideapp:record' %}">å–æ¶ˆç·¨è¼¯</a>
        </div>
        {% endif %}
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div class="form-group">
                <label class="form-label" for="id_date">æ—¥æœŸ</label>
                {{ meal_form.date }}
                {% if meal_form.date.errors %}<p class="form-error">{{ meal_form.date.errors.0 }}</p>{% endif %}
            </div>
            <div class="form-group">
                <label class="form-label" for="id_meal_type">é¤æ¬¡</label>
                {{ meal_form.meal_type }}
                {% if meal_form.meal_type.errors %}<p class="form-error">{{ meal_form.meal_type.errors.0 }}</p>{% endif %}
            </div>
            <div class="form-group">
                <label class="form-label" for="id_meal_name">é¤é»åç¨±</label>
                {{ meal_form.meal_name }}
                {% if meal_form.meal_name.errors %}<p class="form-error">{{ meal_form.meal_name.errors.0 }}</p>{% endif %}
            </div>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div class="form-group">
                <label class="form-label" for="id_restaurant">é¤å»³</label>
                {{ meal_form.restaurant }}
                {% if meal_form.restaurant.errors %}<p class="form-error">{{ meal_form.restaurant.errors.0 }}</p>{% endif %}
            </div>
            <div class="form-group">
                <label class="form-label" for="id_source_meal">é¸æ“‡é¤é»</label>
                {{ meal_form.source_meal }}
                {% if meal_form.source_meal.errors %}<p class="form-error">{{ meal_form.source_meal.errors.0 }}</p>{% endif %}
            </div>
        </div>
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
            <div class="form-group">
                <label class="form-label" for="id_calories">ç¸½ç†±é‡ (kcal)</label>
                {{ meal_form.calories }}
                {% if meal_form.calories.errors %}<p class="form-error">{{ meal_form.calories.errors.0 }}</p>
                {% endif %}
            </div>
            <div class="form-group">
                <label class="form-label" for="id_protein_grams">è›‹ç™½è³ª (g)</label>
                {{ meal_form.protein_grams }}
                {% if meal_form.protein_grams.errors %}<p class="form-error">{{ meal_form.protein_grams.errors.0 }}</p>
                {% endif %}
            </div>
            <div class="form-group">
                <label class="form-label" for="id_carb_grams">ç¢³æ°´ (g)</label>
                {{ meal_form.carb_grams }}
                {% if meal_form.carb_grams.errors %}<p class="form-error">{{ meal_form.carb_grams.errors.0 }}</p>
                {% endif %}
            </div>
            <div class="form-group">
                <label class="form-label" for="id_fat_grams">è„‚è‚ª (g)</label>
                {{ meal_form.fat_grams }}
                {% if meal_form.fat_grams.errors %}<p class="form-error">{{ meal_form.fat_grams.errors.0 }}</p>
                {% endif %}
            </div>
        </div>
        <div class="form-group">
            <label class="form-label" for="id_ingredients_text">é£Ÿæ/å…§å®¹ç‰©</label>
            {{ meal_form.ingredients_text }}
            {% if meal_form.ingredients_text.errors %}<p class="form-error">
                {{ meal_form.ingredients_text.errors.0 }}
            </p>{% endif %}
        </div>
        <div class="form-group">
            <label class="form-label">é¤é»çµ„æˆ</label>
            <div class="border border-slate-200 rounded-lg p-4 bg-slate-50" id="component-builder">
                <div
                    class="grid grid-cols-3 gap-2 text-xs font-medium text-slate-500 uppercase tracking-wider mb-2 px-1">
                    <span>åç¨±</span>
                    <span>ä»½é‡</span>
                    <span>ç†±é‡</span>
                </div>
                <div id="component-rows" class="space-y-2"></div>
                <button class="btn-secondary mt-3" type="button" id="add-component">ï¼‹ æ–°å¢çµ„æˆ</button>
            </div>
            {{ meal_form.components_payload }}
            {% if meal_form.components_payload.errors %}<p class="form-error">
                {{ meal_form.components_payload.errors.0 }}</p>{% endif %}
        </div>
        <div class="form-group">
            <label class="form-label" for="id_meal_notes">å‚™è¨»</label>
            {{ meal_form.meal_notes }}
            {% if meal_form.meal_notes.errors %}<p class="form-error">{{ meal_form.meal_notes.errors.0 }}</p>
            {% endif %}
        </div>
        {% if meal_form.non_field_errors %}
        <div class="alert-error">
            {% for error in meal_form.non_field_errors %}<p>{{ error }}</p>{% endfor %}
        </div>
        {% endif %}
        <div class="flex flex-wrap gap-3 pt-2">
            <button class="btn-primary" type="submit">
                {% if editing_record %}å„²å­˜è®Šæ›´{% else %}å„²å­˜ç´€éŒ„{% endif %}
            </button>
            {% if editing_record %}
            <a class="btn-secondary" href="{% url 'usersideapp:record' %}">é‡æ–°æ–°å¢</a>
            {% endif %}
        </div>
    </form>
</div>

<!-- Timeline Records -->
<h2 class="text-lg font-bold text-slate-800 mt-8 mb-4">é£²é£Ÿç´€éŒ„</h2>
{% if history_records %}
<div class="space-y-4">
    {% for record in history_records %}
    <article class="card">
        <header
            class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 pb-4 border-b border-slate-100">
            <div>
                <p class="font-semibold text-slate-800">{{ record.date|date:"m/d" }} Â· 
                    {{ record.get_meal_type_display }}</p>
                <p class="text-sm text-slate-500">{{ record.meal_name }}</p>
            </div>
            <div class="flex flex-wrap gap-2">
                <span
                    class="inline-flex items-center gap-1 px-2 py-1 rounded-full text-xs font-medium bg-orange-100 text-orange-700">ğŸ½
                    {{ record.calories }} kcal</span>
                <span
                    class="inline-flex items-center gap-1 px-2 py-1 rounded-full text-xs font-medium bg-amber-100 text-amber-700">ğŸ¥š
                    {{ record.protein_grams }} g</span>
                <span
                    class="inline-flex items-center gap-1 px-2 py-1 rounded-full text-xs font-medium bg-emerald-100 text-emerald-700">ğŸŒ¾
                    {{ record.carb_grams }} g</span>
                <span
                    class="inline-flex items-center gap-1 px-2 py-1 rounded-full text-xs font-medium bg-violet-100 text-violet-700">ğŸ¥‘
                    {{ record.fat_grams }} g</span>
            </div>
            <div class="flex items-center gap-3">
                <a class="text-sm font-medium text-primary hover:text-primary-dark hover:underline"
                    href="?range={{ selected_range }}&edit={{ record.id }}#record-form-section">ç·¨è¼¯</a>
                <form method="post" class="inline">
                    {% csrf_token %}
                    <input type="hidden" name="intent" value="delete">
                    <input type="hidden" name="record_id" value="{{ record.id }}">
                    <button type="submit"
                        class="text-sm font-medium text-red-600 hover:text-red-800 hover:underline">åˆªé™¤</button>
                </form>
            </div>
        </header>
        <div class="pt-4 space-y-3 text-sm text-slate-600">
            {% if record.source_meal %}
            <p>
                ä¾†æºï¼š
                <a class="text-primary hover:underline"
                    href="{% url 'merchantsideapp:restaurant_detail' record.source_meal.restaurant.id %}"
                    target="_blank" rel="noopener">{{ record.source_meal.restaurant.name }}</a>
                Â·
                <a class="text-primary hover:underline"
                    href="{% url 'merchantsideapp:meal_detail' record.source_meal.id %}" target="_blank"
                    rel="noopener">{{ record.source_meal.name }}</a>
            </p>
            {% endif %}
            {% with component_list=record.components.all %}
            {% if component_list %}
            <ul class="grid grid-cols-2 sm:grid-cols-3 gap-2 mt-2">
                {% for component in component_list %}
                <li class="flex items-center justify-between p-2 bg-slate-50 rounded-lg text-xs">
                    <strong class="font-medium text-slate-700">{{ component.name }}</strong>
                    <span class="text-slate-500">{{ component.quantity|default:"" }} Â· {{ component.calories }}
                        kcal</span>
                </li>
                {% endfor %}
            </ul>
            {% endif %}
            {% endwith %}
            {% if record.ingredients %}
            <p>å…§å®¹ç‰©ï¼š{{ record.ingredients|join:", " }}</p>
            {% endif %}
            {% if record.meal_notes %}
            <p class="text-slate-500">å‚™è¨»ï¼š{{ record.meal_notes }}</p>
            {% endif %}
        </div>
    </article>
    {% endfor %}
</div>
{% else %}
<div class="card text-center py-12">
    <p class="text-slate-500">ç›®å‰å°šç„¡ç´€éŒ„ï¼Œå…ˆå¾ä¸Šæ–¹è¡¨å–®æ–°å¢ä¸€ç­†å§ï¼</p>
</div>
{% endif %}
{% endblock %}