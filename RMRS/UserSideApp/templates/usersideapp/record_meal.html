{% extends 'usersideapp/base_sidebar.html' %}
{% load static %}
{% block page_title %}é£²é£Ÿç´€éŒ„{% endblock %}
{% block extra_js %}
<script src="{% static 'usersideapp/js/meal_record.js' %}" defer data-component-seed="{{ components_seed|escapejs }}"
    data-meal-api="{% url 'usersideapp:restaurant_meals_api' %}" data-initial-restaurant="{{ initial_restaurant_id }}"
    data-initial-meal="{{ initial_meal_id }}"></script>
{% endblock %}
{% block content %}
<div class="welcome-box record-header">
    <div class="record-left">
        <h1>é£²é£Ÿç´€éŒ„</h1>
        <p>å»ºç«‹é£²é£Ÿæ—¥èªŒä¸¦è¿½è¹¤ç‡Ÿé¤Šæ”å–ï¼Œç³»çµ±æœƒè‡ªå‹•é¿å…åŒé¤é»æ–¼åŒä¸€é€±é‡è¤‡ã€‚</p>
    </div>
    <div class="record-right">
        <div class="record-filter-bar">
            {% for value,label in range_filters %}
            <a class="filter-pill {% if selected_range == value %}active{% endif %}" href="?range={{ value }}">
                {{ label }}</a>
            {% endfor %}
        </div>
        <div class="range-meta">
            <div class="range-meta__label">{{ selected_range_meta.label }}</div>
            <div class="range-meta__window">{{ selected_range_meta.date_window }} Â· {{ selected_range_meta.days }} å¤©
            </div>
            <div class="range-meta__hint">{{ selected_range_meta.logic_hint }}</div>
        </div>
    </div>
</div>

<div class="card-long stats-card">
    <div class="stats-card__header">
        <div>
            <p class="stats-card__eyebrow">æœŸé–“ç¸½è¦½</p>
            <h3 class="stats-card__title">{{ selected_range_meta.label }}</h3>
            <p class="stats-card__subtitle">{{ selected_range_meta.date_window }} Â· {{ selected_range_meta.days }} å¤©</p>
        </div>
        <div class="stats-card__summary">
            <span class="meta-label">ç´€éŒ„æ•¸é‡</span>
            <strong>{{ history_records|length }}</strong>
        </div>
    </div>
    <div class="stats-card__grid">
        <div class="stat-tile stat-tile--calorie">
            <div class="stat-icon" aria-hidden="true">ğŸ”¥</div>
            <div>
                <span class="label">å¡è·¯é‡Œ</span>
                <strong>{{ history_totals.total_calories|floatformat:0 }} kcal</strong>
            </div>
        </div>
        <div class="stat-tile stat-tile--protein">
            <div class="stat-icon" aria-hidden="true">ğŸ¥š</div>
            <div>
                <span class="label">è›‹ç™½è³ª</span>
                <strong>{{ history_totals.total_protein|floatformat:1 }} g</strong>
            </div>
        </div>
        <div class="stat-tile stat-tile--carb">
            <div class="stat-icon" aria-hidden="true">ğŸŒ¾</div>
            <div>
                <span class="label">ç¢³æ°´åŒ–åˆç‰©</span>
                <strong>{{ history_totals.total_carbs|floatformat:1 }} g</strong>
            </div>
        </div>
        <div class="stat-tile stat-tile--fat">
            <div class="stat-icon" aria-hidden="true">ğŸ¥‘</div>
            <div>
                <span class="label">è„‚è‚ª</span>
                <strong>{{ history_totals.total_fat|floatformat:1 }} g</strong>
            </div>
        </div>
    </div>
</div>

<div class="section-title" id="record-form-section">
    {% if editing_record %}
    ç·¨è¼¯é£²é£Ÿç´€éŒ„
    {% else %}
    æ–°å¢é£²é£Ÿç´€éŒ„
    {% endif %}
</div>
<div class="card-long">
    <form method="post" class="meal-form" id="meal-record-form">
        {% csrf_token %}
        <input type="hidden" name="intent" id="meal-form-intent"
            value="{% if editing_record %}update{% else %}create{% endif %}">
        <input type="hidden" name="record_id" id="meal-form-record-id" value="{{ editing_record.id|default:'' }}">
        {% if editing_record %}
        <div class="editing-banner">
            <span>æ­£åœ¨ç·¨è¼¯ï¼š{{ editing_record.date|date:"m/d" }} Â· {{ editing_record.get_meal_type_display }} Â·
                {{ editing_record.meal_name }}</span>
            <a class="text-btn" href="{% url 'usersideapp:record' %}">å–æ¶ˆç·¨è¼¯</a>
        </div>
        {% endif %}
        <div class="form-grid">
            <div class="form-group">
                <label for="id_date">æ—¥æœŸ</label>
                {{ meal_form.date }}
                {{ meal_form.date.errors }}
            </div>
            <div class="form-group">
                <label for="id_meal_type">é¤æ¬¡</label>
                {{ meal_form.meal_type }}
                {{ meal_form.meal_type.errors }}
            </div>
            <div class="form-group">
                <label for="id_meal_name">é¤é»åç¨±</label>
                {{ meal_form.meal_name }}
                {{ meal_form.meal_name.errors }}
            </div>
        </div>
        <div class="form-grid">
            <div class="form-group">
                <label for="id_restaurant">é¤å»³</label>
                {{ meal_form.restaurant }}
                {{ meal_form.restaurant.errors }}
            </div>
            <div class="form-group">
                <label for="id_source_meal">é¸æ“‡é¤é»</label>
                {{ meal_form.source_meal }}
                {{ meal_form.source_meal.errors }}
            </div>
        </div>
        <div class="form-grid">
            <div class="form-group">
                <label for="id_calories">ç¸½ç†±é‡ (kcal)</label>
                {{ meal_form.calories }}
                {{ meal_form.calories.errors }}
            </div>
            <div class="form-group">
                <label for="id_protein_grams">è›‹ç™½è³ª (g)</label>
                {{ meal_form.protein_grams }}
                {{ meal_form.protein_grams.errors }}
            </div>
            <div class="form-group">
                <label for="id_carb_grams">ç¢³æ°´ (g)</label>
                {{ meal_form.carb_grams }}
                {{ meal_form.carb_grams.errors }}
            </div>
            <div class="form-group">
                <label for="id_fat_grams">è„‚è‚ª (g)</label>
                {{ meal_form.fat_grams }}
                {{ meal_form.fat_grams.errors }}
            </div>
        </div>
        <div class="form-group">
            <label for="id_ingredients_text">é£Ÿæ/å…§å®¹ç‰©</label>
            {{ meal_form.ingredients_text }}
            {{ meal_form.ingredients_text.errors }}
        </div>
        <div class="form-group">
            <label>é¤é»çµ„æˆ</label>
            <div class="component-builder" id="component-builder">
                <div class="component-header">
                    <span>åç¨±</span>
                    <span>ä»½é‡</span>
                    <span>ç†±é‡</span>
                </div>
                <div class="component-rows" id="component-rows"></div>
                <button class="outline-btn" type="button" id="add-component">ï¼‹ æ–°å¢çµ„æˆ</button>
            </div>
            {{ meal_form.components_payload }}
            {{ meal_form.components_payload.errors }}
        </div>
        <div class="form-group">
            <label for="id_meal_notes">å‚™è¨»</label>
            {{ meal_form.meal_notes }}
            {{ meal_form.meal_notes.errors }}
        </div>
        {% if meal_form.non_field_errors %}
        <div class="form-errors">
            {% for error in meal_form.non_field_errors %}
            <p>{{ error }}</p>
            {% endfor %}
        </div>
        {% endif %}
        <div class="form-actions">
            <button class="primary-btn" type="submit">
                {% if editing_record %}å„²å­˜è®Šæ›´{% else %}å„²å­˜ç´€éŒ„{% endif %}
            </button>
            {% if editing_record %}
            <a class="outline-btn" href="{% url 'usersideapp:record' %}">é‡æ–°æ–°å¢</a>
            {% endif %}
        </div>
    </form>
</div>

<div class="section-title">é£²é£Ÿç´€éŒ„</div>
{% if history_records %}
<div class="record-list timeline-list">
    {% for record in history_records %}
    <article class="card-long record-item timeline-card">
        <header class="timeline-card__header">
            <div>
                <p class="record-date-main">{{ record.date|date:"m/d" }} Â· {{ record.get_meal_type_display }}</p>
                <p class="record-date-sub">{{ record.meal_name }}</p>
            </div>
            <div class="record-macro-chips">
                <span class="macro-chip">ğŸ½ {{ record.calories }} kcal</span>
                <span class="macro-chip">ğŸ¥š {{ record.protein_grams }} g</span>
                <span class="macro-chip">ğŸŒ¾ {{ record.carb_grams }} g</span>
                <span class="macro-chip">ğŸ¥‘ {{ record.fat_grams }} g</span>
            </div>
            <div class="record-actions">
                <a class="text-btn" href="?range={{ selected_range }}&edit={{ record.id }}#record-form-section">ç·¨è¼¯</a>
                <form method="post" class="inline-form">
                    {% csrf_token %}
                    <input type="hidden" name="intent" value="delete">
                    <input type="hidden" name="record_id" value="{{ record.id }}">
                    <button type="submit" class="text-btn">åˆªé™¤</button>
                </form>
            </div>
        </header>
        <div class="timeline-card__body">
            {% if record.source_meal %}
            <p class="record-source">
                ä¾†æºï¼š
                <a href="{% url 'merchantsideapp:restaurant_detail' record.source_meal.restaurant.id %}" target="_blank"
                    rel="noopener">{{ record.source_meal.restaurant.name }}</a>
                Â·
                <a href="{% url 'merchantsideapp:meal_detail' record.source_meal.id %}" target="_blank" rel="noopener">
                    {{ record.source_meal.name }}</a>
            </p>
            {% endif %}
            {% with component_list=record.components.all %}
            {% if component_list %}
            <ul class="component-list">
                {% for component in component_list %}
                <li>
                    <strong>{{ component.name }}</strong>
                    <span>{{ component.quantity|default:"" }}</span>
                    <span>{{ component.calories }} kcal</span>
                </li>
                {% endfor %}
            </ul>
            {% endif %}
            {% endwith %}
            {% if record.ingredients %}
            <p>å…§å®¹ç‰©ï¼š{{ record.ingredients|join:", " }}</p>
            {% endif %}
            {% if record.meal_notes %}
            <p>å‚™è¨»ï¼š{{ record.meal_notes }}</p>
            {% endif %}
        </div>
    </article>
    {% endfor %}
</div>
{% else %}
<div class="card-long empty-state">
    ç›®å‰å°šç„¡ç´€éŒ„ï¼Œå…ˆå¾ä¸Šæ–¹è¡¨å–®æ–°å¢ä¸€ç­†å§ï¼
</div>
{% endif %}
{% endblock %}